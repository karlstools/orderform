<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Broadband Material Request</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-selected { border: 2px solid #2563eb; background-color: #eff6ff; }
        #orderInputs { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        
        /* Cart Drawer Styles */
        #cartDrawer {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        #cartDrawer.open {
            transform: translateY(0);
        }
        
        /* NEW: Help Modal Styles */
        #helpModal.hidden {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #helpModal {
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        body.drawer-open {
            overflow: hidden; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-32">

    <div class="bg-white shadow-sm sticky top-0 z-20 border-b border-gray-200">
        
        <div class="max-w-7xl mx-auto px-3 py-2 md:py-4 flex justify-between items-center bg-white z-30 relative">
            <h1 class="text-lg md:text-2xl font-bold text-blue-900 flex items-center gap-2">
                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                Broadband Material Request
            </h1>
            
            <div class="flex items-center gap-3">
                 <button onclick="toggleHelpModal()" class="text-gray-500 hover:text-blue-600 p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9.247a3.75 3.75 0 100 7.5l.448-.15c.621-.21 1.253-.324 1.884-.324 1.83 0 3.315 1.485 3.315 3.315V21h4.002a2 2 0 002-2V5a2 2 0 00-2-2h-4.002c-1.83 0-3.315 1.485-3.315 3.315 0 .631-.115 1.263-.324 1.884l-.15.448zM12 21v-4.002h2.5M12 21H7.5V17.5M12 9a2 2 0 100-4 2 2 0 000 4z"></path></svg>
                </button>
                
                <button onclick="toggleDetails()" id="detailsBtn" class="md:hidden text-xs font-bold text-blue-600 bg-blue-50 px-3 py-2 rounded-full flex items-center gap-1">
                    <span>Order Info</span>
                    <svg id="chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>
            
            <div class="hidden md:flex items-center gap-2 text-sm text-gray-500 font-medium">
                <label for="orderDate">Date:</label>
                <input type="date" id="orderDate" class="bg-gray-50 border border-gray-300 rounded px-2 py-1 text-blue-900 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <div id="orderInputs" class="max-h-0 opacity-0 md:max-h-96 md:opacity-100 border-b md:border-none border-gray-100 bg-slate-50 md:bg-white">
            <div class="max-w-7xl mx-auto px-3 py-3">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 bg-white md:bg-slate-100 p-3 rounded-lg border border-gray-200 md:border-slate-200 shadow-sm md:shadow-none">
                    
                    <div class="md:hidden col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Order Date</label>
                        <input type="date" id="orderDateMobile" onchange="syncDates(this.value)" class="w-full p-2 rounded border border-gray-300 text-sm bg-white">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">From Warehouse</label>
                        <select class="w-full p-2 rounded border border-gray-300 text-sm bg-white" id="fromWarehouse">
                            <option value="WAREHOUSE 1">Warehouse 1</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">To Warehouse/Truck</label>
                        <input type="text" class="w-full p-2 rounded border border-gray-300 text-sm" placeholder="Truck Number" id="toWarehouse">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Issued By</label>
                        <input type="text" class="w-full p-2 rounded border border-gray-300 text-sm" id="issuedBy">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Received By</label>
                        <input type="text" class="w-full p-2 rounded border border-gray-300 text-sm" id="receivedBy">
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-3 pb-3 pt-1 bg-white">
            <div class="relative mb-2">
                <input type="text" id="searchInput" placeholder="Search equipment..." class="w-full pl-9 pr-4 py-2 rounded-lg border border-gray-300 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <svg class="w-4 h-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="filterCategory('All')" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-bold shadow-sm cat-btn active-cat whitespace-nowrap flex-shrink-0">All</button>
                <button onclick="filterCategory('Equipment')" class="px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-50 cat-btn whitespace-nowrap flex-shrink-0">Equipment</button>
                <button onclick="filterCategory('Fiber/Copper')" class="px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-50 cat-btn whitespace-nowrap flex-shrink-0">Fiber/Copper</button>
                <button onclick="filterCategory('Plates/Jacks')" class="px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-50 cat-btn whitespace-nowrap flex-shrink-0">Wall Plates</button>
                <button onclick="filterCategory('Hardware')" class="px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-50 cat-btn whitespace-nowrap flex-shrink-0">Hardware</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-3 py-4">
        <div id="gridContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
            </div>
    </div>

    <div id="helpModal" class="fixed inset-0 z-50 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-full overflow-hidden flex flex-col">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-xl font-bold text-blue-900">Application Help (README)</h2>
                <button onclick="toggleHelpModal()" class="text-gray-500 hover:text-gray-800 p-1 rounded-full bg-gray-100 hover:bg-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 overflow-y-auto text-sm readme-content flex-grow">
                <p class="mb-4">This document provides an overview and instructions for the **Broadband Material Request Form**, a single-page web application designed for quick material ordering and generation of a formal issue sheet.</p>

                <h3 class="text-lg font-bold text-blue-700 mt-4 mb-2">üí° Overview</h3>
                <p class="mb-4">The application is a client-side tool allowing field staff to select required materials from a categorized catalog, specify order details (like truck number and personnel), and instantly generate a standardized Excel file (.xlsx) suitable for formal documentation and inventory tracking. It is built as a highly responsive, app-like experience for use on mobile devices and desktop browsers.</p>

                <h3 class="text-lg font-bold text-blue-700 mt-4 mb-2">üõ†Ô∏è Technology & Dependencies</h3>
                <p>This application is built entirely on the client side (in the user's browser) using:</p>
                <ul class="list-disc list-inside ml-4 space-y-1 mb-4">
                    <li>**HTML5 & Vanilla JavaScript**: Core structure and operational logic.</li>
                    <li>**Tailwind CSS (via CDN)**: Provides modern, utility-first styling and ensures responsiveness.</li>
                    <li>**SheetJS (js-xlsx via CDN)**: Essential library for generating and formatting the final Excel spreadsheet file.</li>
                </ul>

                <h3 class="text-lg font-bold text-blue-700 mt-4 mb-2">üöÄ Key Features</h3>
                <ul class="list-disc list-inside ml-4 space-y-1 mb-4">
                    <li>**Mobile-Optimized Interface**: Designed for rapid item selection on a small screen with sticky headers, search, and category filters.</li>
                    <li>**Interactive Catalog**: Allows quantity selection directly on the main grid. Selected items are visually highlighted.</li>
                    <li>**Dynamic Cart Drawer**: A slide-up interface to review, modify, and remove items before download.</li>
                    <li>**Required Field Validation**: Ensures the **Truck Number** is entered before the download can proceed.</li>
                    <li>**Automatic Excel Generation**: Outputs a structured material issue sheet with item IDs, descriptions, and requested quantities, along with necessary header information (Date, Warehouses, Personnel).</li>
                </ul>

                <h3 class="text-lg font-bold text-blue-700 mt-4 mb-2">üìù How to Use</h3>
                <ol class="list-decimal list-inside ml-4 space-y-3 mb-4">
                    <li>
                        <strong class="text-gray-800">Enter Order Details</strong>
                        <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                            <li>On desktop, the input fields are visible at the top.</li>
                            <li>On mobile, tap the **"Order Info"** button to toggle the details section open.</li>
                            <li>Fill out the Order Date, To Warehouse/Truck (mandatory), Issued By, and Received By fields.</li>
                        </ul>
                    </li>
                    <li>
                        <strong class="text-gray-800">Select Materials</strong>
                        <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                            <li>Use the **Search** input to quickly find items by name or ID.</li>
                            <li>Use the **Category** buttons (e.g., Equipment, Fiber/Copper) to filter the grid.</li>
                            <li>Use the **+** and **-** buttons on the item cards to set the desired quantity. The running **Total Items** count is displayed in the footer.</li>
                        </ul>
                    </li>
                    <li>
                        <strong class="text-gray-800">Review and Download</strong>
                        <ul class="list-disc list-inside ml-4 mt-1 space-y-1">
                            <li>Tap **"View Cart"** in the footer to open the Cart Drawer for a full review of selected items.</li>
                            <li>Click the green **"Download Order"** button (available in both the footer and the cart drawer).</li>
                            <li>The browser will download an Excel file named: **[YYYY-MM-DD] [Truck Number] broadband order request.xlsx**.</li>
                        </ul>
                    </li>
                </ol>

                <h3 class="text-lg font-bold text-red-700 mt-4 mb-2">‚ö†Ô∏è Maintenance Notes</h3>
                <ul class="list-disc list-inside ml-4 space-y-1 mb-4">
                    <li>**Hardcoded Catalog**: The entire material list is hardcoded in the &lt;script&gt; tag. To update the catalog (add/remove items or change IDs), the source HTML file must be edited and re-uploaded.</li>
                    <li>**No Data Persistence**: Cart selections and input fields are not saved if the page is closed or refreshed. The user must complete the order and download the Excel file in a single session.</li>
                    <li>**Unique IDs**: Note that some items use the ID "NA". While this works for the current functionality, using unique, actual part numbers is highly recommended for inventory system compatibility.</li>
                </ul>
                
            </div>
        </div>
    </div>
    
    <div id="cartDrawer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-2xl z-40 max-h-[80vh] flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white">
            <h2 class="text-xl font-bold text-blue-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                Your Material Cart
                <span id="cartTotalItems" class="text-sm bg-blue-600 text-white rounded-full px-2 py-0.5 ml-1">0</span>
            </h2>
            <button onclick="toggleCartDrawer()" class="text-gray-500 hover:text-gray-800 p-1 rounded-full bg-gray-100 hover:bg-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div id="cartList" class="flex-grow overflow-y-auto p-4 space-y-3">
            <p class="text-center text-gray-500 py-12">Your cart is empty. Add items from the catalog above.</p>
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="generateExcel()" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white px-4 py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                <span>Download Order with <span id="cartDownloadCount">0</span> Items</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
        </div>
    </div>
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] p-3 z-30 safe-area-pb">
        <div class="max-w-7xl mx-auto flex justify-between items-center gap-4">
            <div class="flex flex-col">
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Total Items</div>
                <div class="text-xl font-black text-blue-900 leading-none"><span id="totalCount">0</span></div>
            </div>
            
            <button onclick="toggleCartDrawer()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95 text-sm flex-1 md:flex-none">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span class="hidden md:inline">View</span> Cart
            </button>

            <button onclick="generateExcel()" class="bg-green-600 hover:bg-green-700 active:bg-green-800 text-white px-4 py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95 flex-1">
                <span>Download Order</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const catalog = [
            { id: "80610", name: "4 PORT WALL PLATE, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80612", name: "2 PORT WALL PLATE, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80614", name: "1 PORT WALL PLATE, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80616", name: "CAT5e KEYSTONE, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80618", name: "F CONNECTOR, FOR COAX WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80620", name: "4 PORT WALL PLATE, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80622", name: "2 PORT WALL PLATE, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80624", name: "1 PORT WALL PLATE, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80628", name: "F CONNECTOR, FOR COAX IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80630", name: "8\" UV CABLE TIES (BAG)", category: "Hardware", isPopular: false },
            { id: "80632", name: "7' CAT5e PATCH CABLE", category: "Fiber/Copper", isPopular: false },
            { id: "80636", name: "DRYWALL BRACKET", category: "Hardware", isPopular: false },
            { id: "80640", name: "SURFACE MOUNT 1 PORT, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80642", name: "SURFACE MOUNT 2 PORT, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80644", name: "SURFACE MOUNT 1 PORT, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80646", name: "SURFACE MOUNT 2 PORT, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "7' CONVERSION CABLE - BLUE-GREEN", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "7' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "25' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "50' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "75' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "100' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "125' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "150' FIBER JUMPER", category: "Fiber/Copper", isPopular: false },
            { id: "80634", name: "SILICONE", category: "Hardware", isPopular: false },
            { id: "80654", name: "SCOTCH LOCKS", category: "Hardware", isPopular: false },
            { id: "NA", name: "TII BOXES-WHITE", category: "Plates/Jacks", isPopular: true },
            { id: "NA", name: "TII BOXES-GRAY", category: "Hardware", isPopular: false },
            { id: "NA", name: "BOX OF CAT 6", category: "Fiber/Copper", isPopular: false },
            { id: "NA", name: "RJ11", category: "Hardware", isPopular: false },
            { id: "NA", name: "CAT5 CLIPS", category: "Hardware", isPopular: false },
            { id: "NA", name: "ELECTRICAL TAPE", category: "Hardware", isPopular: false },
            { id: "NA", name: "CABLE CLIP SCREWS", category: "Hardware", isPopular: false },
            { id: "NA", name: "PHONE INSERT, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "PHONE INSERT, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "BLANK INSERT, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "BLANK INSERT, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "HDMI CORDS", category: "Hardware", isPopular: false },
            { id: "NA", name: "AMINO REMOTES", category: "Equipment", isPopular: false },
            { id: "NA", name: "AA BATTERIES", category: "Hardware", isPopular: false },
            { id: "NA", name: "AAA BATTERIES", category: "Hardware", isPopular: false },
            { id: "NA", name: "9V BATTERIES", category: "Hardware", isPopular: false },
            { id: "NA", name: "RJ45", category: "Hardware", isPopular: false },
            { id: "80030", name: "PLUME POD", category: "Equipment", isPopular: false },
            { id: "80603", name: "GP1100X", category: "Equipment", isPopular: true },
            { id: "80005", name: "HD SET TOP 651", category: "Equipment", isPopular: false },
            { id: "80005", name: "WIRELESS 7B 5C", category: "Equipment", isPopular: true },
            { id: "80005", name: "HD SET TOP 7X", category: "Equipment", isPopular: false },
            { id: "80006", name: "SET BACK BOX", category: "Equipment", isPopular: false },
            { id: "80015", name: "AMINO AMULET DVR", category: "Equipment", isPopular: false },
            { id: "80604", name: "U4/GS2028E", category: "Equipment", isPopular: false },
            { id: "80605", name: "U6/GS4227W", category: "Equipment", isPopular: false },
            { id: "80606", name: "U4M/GM1028", category: "Equipment", isPopular: false },
            { id: "80607", name: "10G OPTI", category: "Equipment", isPopular: false },
            { id: "80608", name: "1G OPTI", category: "Equipment", isPopular: false },
            { id: "80910", name: "U10X", category: "Equipment", isPopular: false },
            { id: "80609", name: "4200 OUTDOOR ONT", category: "Equipment", isPopular: false },
            { id: "NA", name: "XGSPON Calix SFP+", category: "Hardware", isPopular: false },
            { id: "NA", name: "U6TXG", category: "Equipment", isPopular: true },
            { id: "NA", name: "GP1101", category: "Equipment", isPopular: true },
            { id: "80907", name: "U6T", category: "Equipment", isPopular: true }
        ];

        catalog.forEach((item, index) => { item.uid = index; });

        // --- STATE ---
        let cart = {};  
        let currentFilter = 'All';
        let isDetailsOpen = false;

        // Initialize Dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('orderDate').value = today;
        document.getElementById('orderDateMobile').value = today;

        renderGrid();
        renderCart(); // Initial render to set footer counts

        function syncDates(val) {
            document.getElementById('orderDate').value = val;
            document.getElementById('orderDateMobile').value = val;
        }

        // --- TOGGLE MOBILE DETAILS ---
        function toggleDetails() {
            const el = document.getElementById('orderInputs');
            const chev = document.getElementById('chevron');
            isDetailsOpen = !isDetailsOpen;
            
            if(isDetailsOpen) {
                el.style.maxHeight = "600px";
                el.style.opacity = "1";
                chev.style.transform = "rotate(180deg)";
            } else {
                el.style.maxHeight = "0";
                el.style.opacity = "0";
                chev.style.transform = "rotate(0deg)";
            }
        }

        // --- HELP MODAL LOGIC (NEW) ---
        function toggleHelpModal() {
            const modal = document.getElementById('helpModal');
            const body = document.body;
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                body.classList.add('drawer-open'); // Reusing drawer-open style to prevent main scroll
            } else {
                modal.classList.add('hidden');
                body.classList.remove('drawer-open');
            }
        }

        // --- CART DRAWER LOGIC ---
        function toggleCartDrawer() {
            const body = document.body;
            const drawer = document.getElementById('cartDrawer');
            
            const cartItemsCount = Object.keys(cart).filter(key => cart[key] > 0).length;
            const isOpen = drawer.classList.contains('open');

            if (!isOpen) {
                if (cartItemsCount === 0) {
                    alert("Your cart is empty. Please add items before viewing the cart.");
                    return;
                }
                drawer.classList.add('open');
                body.classList.add('drawer-open');
                renderCart();
            } else {
                drawer.classList.remove('open');
                body.classList.remove('drawer-open');
            }
        }

        function renderCart() {
            const cartList = document.getElementById('cartList');
            cartList.innerHTML = '';
            let totalUniqueItems = 0; // Count of unique items (rows) in cart
            
            const cartCatalog = catalog
                .filter(item => cart[item.name] > 0)
                .sort((a, b) => a.name.localeCompare(b.name));
            
            if (cartCatalog.length === 0) {
                cartList.innerHTML = '<p class="text-center text-gray-500 py-12">Your cart is empty. Add items from the catalog above.</p>';
            } else {
                cartCatalog.forEach(item => {
                    const qty = cart[item.name];
                    totalUniqueItems++;
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-100';
                    
                    const uid = item.uid;

                    itemDiv.innerHTML = `
                        <div class="flex flex-col flex-grow min-w-0 mr-4">
                            <span class="text-xs font-mono bg-white text-gray-500 px-1.5 py-0.5 rounded self-start">${item.id}</span>
                            <h4 class="font-semibold text-sm text-gray-800 truncate">${item.name}</h4>
                        </div>
                        <div class="flex items-center flex-shrink-0">
                            <button onclick="updateQty(${uid}, -1)" class="w-7 h-7 flex items-center justify-center rounded bg-white shadow-sm text-gray-600 active:bg-gray-200 font-bold text-base touch-manipulation border border-gray-200">-</button>
                            <span class="w-8 text-center font-bold text-gray-800 text-base mx-1">${qty}</span>
                            <button onclick="updateQty(${uid}, 1)" class="w-7 h-7 flex items-center justify-center rounded bg-blue-600 shadow-sm text-white active:bg-blue-800 font-bold text-base touch-manipulation">+</button>
                        </div>
                    `;
                    cartList.appendChild(itemDiv);
                });
            }

            // Update all visible counts
            document.getElementById('totalCount').innerText = totalUniqueItems;
            document.getElementById('cartTotalItems').innerText = totalUniqueItems;
            document.getElementById('cartDownloadCount').innerText = totalUniqueItems;

            // Auto-close drawer if cart is empty
            const drawer = document.getElementById('cartDrawer');
            if (totalUniqueItems === 0 && drawer.classList.contains('open')) {
                drawer.classList.remove('open');
                document.body.classList.remove('drawer-open');
            }
        }
        // --- END CART LOGIC ---


        // --- UI (EXISTING FUNCTIONS MODIFIED TO CALL renderCart) ---
        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let displayList = [...catalog].sort((a, b) => (a.isPopular === b.isPopular) ? 0 : a.isPopular ? -1 : 1);

            displayList.forEach(item => {
                if (currentFilter !== 'All' && item.category !== currentFilter) return;
                if (searchTerm && !item.name.toLowerCase().includes(searchTerm) && !item.id.toLowerCase().includes(searchTerm)) return;

                const qty = cart[item.name] || 0;
                const isSelected = qty > 0;
                let icon = getIconForCategory(item.category);

                const card = document.createElement('div');
                card.className = `bg-white p-3 rounded-xl shadow-sm border transition ${isSelected ? 'card-selected' : 'border-gray-200'}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-mono bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">${item.id}</span>
                        ${item.isPopular ? '<span class="text-[9px] text-amber-600 font-bold uppercase tracking-wide flex items-center gap-1">‚òÖ Pop</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2 mb-2 h-10">
                        ${icon}
                        <h3 class="font-semibold text-gray-800 text-xs leading-tight line-clamp-2">${item.name}</h3>
                    </div>
                    
                    <div class="flex items-center justify-between mt-auto bg-gray-50 rounded-lg p-1 border border-gray-100">
                        <button onclick="updateQty(${item.uid}, -1)" class="w-8 h-8 flex items-center justify-center rounded bg-white shadow-sm text-gray-600 active:bg-gray-200 font-bold text-lg touch-manipulation">-</button>
                        <input type="number" value="${qty}" class="w-10 text-center bg-transparent font-bold text-gray-800 focus:outline-none text-lg" readonly>
                        <button onclick="updateQty(${item.uid}, 1)" class="w-8 h-8 flex items-center justify-center rounded bg-blue-600 shadow-sm text-white active:bg-blue-800 font-bold text-lg touch-manipulation">+</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateQty(uid, change) {
            const item = catalog[uid];  
            if (!item) return;
            if (!cart[item.name]) cart[item.name] = 0;
            
            cart[item.name] += change;
            
            if (cart[item.name] < 0) cart[item.name] = 0;
            
            // Clean up zero-quantity entries
            if (cart[item.name] === 0) {
                delete cart[item.name];
            }
            
            renderGrid();
            // Call renderCart to update counts and drawer contents/state
            renderCart(); 
        }

        function getIconForCategory(cat) {
            if (cat === 'Equipment') return '<div class="w-5 h-5 text-purple-500 flex-shrink-0"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg></div>';
            if (cat === 'Fiber/Copper') return '<div class="w-5 h-5 text-green-500 flex-shrink-0"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>';
            if (cat === 'Plates/Jacks') return '<div class="w-5 h-5 text-orange-500 flex-shrink-0"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></div>';
            return '<div class="w-5 h-5 text-gray-400 flex-shrink-0"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg></div>';
        }

        function filterCategory(cat) {
            currentFilter = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                const btnText = btn.innerText;
                // Simplified comparison for activation
                const targetCat = (cat === 'Plates/Jacks') ? 'Wall Plates' : cat;
                
                if(btnText === targetCat || (cat === 'All' && btnText === 'All')) {
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.remove('bg-white', 'border-gray-200', 'text-gray-600', 'hover:bg-gray-50');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'border-gray-200', 'text-gray-600', 'hover:bg-gray-50');
                }
            });
            renderGrid();
        }

        document.getElementById('searchInput').addEventListener('keyup', renderGrid);

        function generateExcel() {
            const drawer = document.getElementById('cartDrawer');
            if(drawer.classList.contains('open')) toggleCartDrawer(); // Close drawer on download

            // 1. Check if cart is empty
            const cartItemsCount = Object.keys(cart).filter(key => cart[key] > 0).length;
            if (cartItemsCount === 0) {
                 alert("Your cart is empty. Please add items before downloading the request form.");
                 toggleCartDrawer(); 
                 return;
            }

            const issuedBy = document.getElementById('issuedBy').value.trim();
            const toWh = document.getElementById('toWarehouse').value.trim();
            
            // 2. Check if Truck Number is provided (NEW REQUIREMENT)
            if (!toWh) {
                 alert("Please enter the Truck Number in the 'To Warehouse/Truck' field before downloading.");
                 if(!isDetailsOpen) toggleDetails();
                 document.getElementById('toWarehouse').focus();
                 return;
            }

            // 3. Optional Check for Issued By
            if(!issuedBy && !confirm("The 'Issued By' field is empty. Do you want to download anyway?")) {
                if(!isDetailsOpen) toggleDetails();
                document.getElementById('issuedBy').focus();
                return;
            }

            const fromWh = document.getElementById('fromWarehouse').value;
            const receivedBy = document.getElementById('receivedBy').value;
            
            // GET DATE FROM INPUT
            const rawDate = document.getElementById('orderDate').value;
            const dateStr = new Date(rawDate + "T00:00:00").toLocaleDateString();  

            // Split ALL catalog items into two columns for the Excel sheet layout
            const midpoint = Math.ceil(catalog.length / 2);
            const leftColItems = catalog.slice(0, midpoint);
            const rightColItems = catalog.slice(midpoint);

            let ws_data = [
                ["BROADBAND MATERIAL ISSUE SHEET"], 
                [], 
                ["FROM WAREHOUSE:", fromWh, "", "ISSUED BY:", issuedBy, "DATE:", dateStr],
                ["TO WAREHOUSE:", toWh, "", "RECEIVED BY:", receivedBy, "", ""],
                [], 
                ["ITEM #", "DESCRIPTION", "QTY", "", "ITEM #", "DESCRIPTION", "QTY"], 
            ];

            const maxRows = Math.max(leftColItems.length, rightColItems.length);

            for (let i = 0; i < maxRows; i++) {
                const leftItem = leftColItems[i] || { id: "", name: "" };
                const rightItem = rightColItems[i] || { id: "", name: "" };

                // Use the quantity from the cart state, only if > 0, otherwise empty string
                const leftQty = cart[leftItem.name] > 0 ? cart[leftItem.name] : "";
                const rightQty = cart[rightItem.name] > 0 ? cart[rightItem.name] : "";

                ws_data.push([
                    leftItem.id, leftItem.name, leftQty, "", 
                    rightItem.id, rightItem.name, rightQty
                ]);
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch: 10}, {wch: 35}, {wch: 8}, {wch: 5}, {wch: 10}, {wch: 35}, {wch: 8} ];

            // Apply merge and styling for the title
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }];
            const titleCell = ws['A1'];
            if (titleCell) {
                titleCell.s = { alignment: { horizontal: "center" } };
            }

            XLSX.utils.book_append_sheet(wb, ws, "Request");
            
            // 4. Set the new file name format (NEW FILE NAMING)
            const fileName = `${rawDate} ${toWh} broadband order request.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>
