<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Broadband Material Request</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-selected { border: 2px solid #2563eb; background-color: #eff6ff; }
        #orderInputs { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        
        /* CORRECTED Cart Drawer Styles */
        #cartDrawer {
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
        }
        /* New class to directly open the drawer */
        #cartDrawer.open {
            transform: translateY(0);
        }
        /* Optional: Add an overlay or disable body scroll when open */
        body.drawer-open {
            overflow: hidden; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 pb-32">

    <div class="bg-white shadow-sm sticky top-0 z-20 border-b border-gray-200">
        
        <div class="max-w-7xl mx-auto px-3 py-2 md:py-4 flex justify-between items-center bg-white z-30 relative">
            <h1 class="text-lg md:text-2xl font-bold text-blue-900 flex items-center gap-2">
                <svg class="w-5 h-5 md:w-6 md:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                Broadband Material Request
            </h1>
            
            <button onclick="toggleDetails()" id="detailsBtn" class="md:hidden text-xs font-bold text-blue-600 bg-blue-50 px-3 py-2 rounded-full flex items-center gap-1">
                <span>üìù Order Info</span>
                <svg id="chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            
            <div class="hidden md:flex items-center gap-2 text-sm text-gray-500 font-medium">
                <label for="orderDate">Date:</label>
                <input type="date" id="orderDate" class="bg-gray-50 border border-gray-300 rounded px-2 py-1 text-blue-900 font-bold focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <div id="orderInputs" class="max-h-0 opacity-0 md:max-h-96 md:opacity-100 border-b md:border-none border-gray-100 bg-slate-50 md:bg-white">
            <div class="max-w-7xl mx-auto px-3 py-3">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 bg-white md:bg-slate-100 p-3 rounded-lg border border-gray-200 md:border-slate-200 shadow-sm md:shadow-none">
                    
                    <div class="md:hidden col-span-2">
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Order Date</label>
                        <input type="date" id="orderDateMobile" onchange="syncDates(this.value)" class="w-full p-2 rounded border border-gray-300 text-sm bg-white">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">From Warehouse</label>
                        <select class="w-full p-2 rounded border border-gray-300 text-sm bg-white" id="fromWarehouse">
                            <option value="1">Warehouse 1</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">To Warehouse/Truck</label>
                        <input type="text" class="w-full p-2 rounded border border-gray-300 text-sm" placeholder="Truck Number" id="toWarehouse">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Issued By</label>
                        <input type="text" class="w-full p-2 rounded border border-gray-300 text-sm" id="issuedBy">
                    </div>
                    <div>
                        <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">Received By</label>
                        <input type="text" class="w-full p-2 rounded border border-gray-300 text-sm" id="receivedBy">
                    </div>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-3 pb-3 pt-1 bg-white">
            <div class="relative mb-2">
                <input type="text" id="searchInput" placeholder="Search equipment..." class="w-full pl-9 pr-4 py-2 rounded-lg border border-gray-300 bg-gray-50 focus:bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                <svg class="w-4 h-4 absolute left-3 top-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>

            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="filterCategory('All')" class="px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-bold shadow-sm cat-btn active-cat whitespace-nowrap flex-shrink-0">All</button>
                <button onclick="filterCategory('Equipment')" class="px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-50 cat-btn whitespace-nowrap flex-shrink-0">Equipment</button>
                <button onclick="filterCategory('Fiber/Copper')" class="px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-50 cat-btn whitespace-nowrap flex-shrink-0">Fiber/Copper</button>
                <button onclick="filterCategory('Plates/Jacks')" class="px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-50 cat-btn whitespace-nowrap flex-shrink-0">Wall Plates</button>
                <button onclick="filterCategory('Hardware')" class="px-3 py-1.5 rounded-lg bg-white border border-gray-200 text-gray-600 text-xs font-bold hover:bg-gray-50 cat-btn whitespace-nowrap flex-shrink-0">Hardware</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-3 py-4">
        <div id="gridContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
            </div>
    </div>

    <div id="cartDrawer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 shadow-2xl z-40 max-h-[80vh] flex flex-col">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center sticky top-0 bg-white">
            <h2 class="text-xl font-bold text-blue-900 flex items-center gap-2">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                Your Material Cart
                <span id="cartTotalItems" class="text-sm bg-blue-600 text-white rounded-full px-2 py-0.5 ml-1">0</span>
            </h2>
            <button onclick="toggleCartDrawer()" class="text-gray-500 hover:text-gray-800 p-1 rounded-full bg-gray-100 hover:bg-gray-200">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div id="cartList" class="flex-grow overflow-y-auto p-4 space-y-3">
            <p class="text-center text-gray-500 py-12">Your cart is empty. Add items from the catalog above.</p>
        </div>
        
        <div class="p-4 border-t border-gray-200">
            <button onclick="generateExcel()" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white px-4 py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95">
                <span>Download Order with <span id="cartDownloadCount">0</span> Items</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
        </div>
    </div>
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_10px_rgba(0,0,0,0.1)] p-3 z-30 safe-area-pb">
        <div class="max-w-7xl mx-auto flex justify-between items-center gap-4">
            <div class="flex flex-col">
                <div class="text-[10px] text-gray-400 uppercase font-bold tracking-wider">Total Items</div>
                <div class="text-xl font-black text-blue-900 leading-none"><span id="totalCount">0</span></div>
            </div>
            
            <button onclick="toggleCartDrawer()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95 text-sm flex-1 md:flex-none">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                <span class="hidden md:inline">View</span> Cart
            </button>
            
            <button onclick="generateExcel()" class="bg-green-600 hover:bg-green-700 active:bg-green-800 text-white px-4 py-3 rounded-xl font-bold shadow-md flex items-center justify-center gap-2 transition-transform active:scale-95 flex-1">
                <span>Download Order</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
        </div>
    </div>

    <script>
        // --- DATA ---
        const catalog = [
            { id: "80610", name: "4 PORT WALL PLATE, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80612", name: "2 PORT WALL PLATE, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80614", name: "1 PORT WALL PLATE, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80616", name: "CAT5e KEYSTONE, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80618", name: "F CONNECTOR, FOR COAX WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80620", name: "4 PORT WALL PLATE, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80622", name: "2 PORT WALL PLATE, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80624", name: "1 PORT WALL PLATE, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80628", name: "F CONNECTOR, FOR COAX IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80630", name: "8\" UV CABLE TIES (BAG)", category: "Hardware", isPopular: false },
            { id: "80632", name: "7' CAT5e PATCH CABLE", category: "Fiber/Copper", isPopular: false },
            { id: "80636", name: "DRYWALL BRACKET", category: "Hardware", isPopular: false },
            { id: "80640", name: "SURFACE MOUNT 1 PORT, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80642", name: "SURFACE MOUNT 2 PORT, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "80644", name: "SURFACE MOUNT 1 PORT, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "80646", name: "SURFACE MOUNT 2 PORT, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "7' CONVERSION CABLE - BLUE-GREEN", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "7' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "25' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "50' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "75' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "100' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "125' FIBER JUMPER", category: "Fiber/Copper", isPopular: true },
            { id: "NA", name: "150' FIBER JUMPER", category: "Fiber/Copper", isPopular: false },
            { id: "80634", name: "SILICONE", category: "Hardware", isPopular: false },
            { id: "80654", name: "SCOTCH LOCKS", category: "Hardware", isPopular: false },
            { id: "NA", name: "TII BOXES-WHITE", category: "Plates/Jacks", isPopular: true },
            { id: "NA", name: "TII BOXES-GRAY", category: "Hardware", isPopular: false },
            { id: "NA", name: "BOX OF CAT 6", category: "Fiber/Copper", isPopular: false },
            { id: "NA", name: "RJ11", category: "Hardware", isPopular: false },
            { id: "NA", name: "CAT5 CLIPS", category: "Hardware", isPopular: false },
            { id: "NA", name: "ELECTRICAL TAPE", category: "Hardware", isPopular: false },
            { id: "NA", name: "CABLE CLIP SCREWS", category: "Hardware", isPopular: false },
            { id: "NA", name: "PHONE INSERT, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "PHONE INSERT, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "BLANK INSERT, WHITE", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "BLANK INSERT, IVORY", category: "Plates/Jacks", isPopular: false },
            { id: "NA", name: "HDMI CORDS", category: "Hardware", isPopular: false },
            { id: "NA", name: "AMINO REMOTES", category: "Equipment", isPopular: false },
            { id: "NA", name: "AA BATTERIES", category: "Hardware", isPopular: false },
            { id: "NA", name: "AAA BATTERIES", category: "Hardware", isPopular: false },
            { id: "NA", name: "9V BATTERIES", category: "Hardware", isPopular: false },
            { id: "NA", name: "RJ45", category: "Hardware", isPopular: false },
            { id: "80030", name: "PLUME POD", category: "Equipment", isPopular: false },
            { id: "80603", name: "GP1100X", category: "Equipment", isPopular: true },
            { id: "80005", name: "HD SET TOP 651", category: "Equipment", isPopular: false },
            { id: "80005", name: "WIRELESS 7B", category: "Equipment", isPopular: true },
            { id: "80005", name: "HD SET TOP 7X", category: "Equipment", isPopular: false },
            { id: "80006", name: "SET BACK BOX", category: "Equipment", isPopular: false },
            { id: "80015", name: "AMINO AMULET DVR", category: "Equipment", isPopular: false },
            { id: "80604", name: "U4/GS2028E", category: "Equipment", isPopular: false },
            { id: "80605", name: "U6/GS4227W", category: "Equipment", isPopular: false },
            { id: "80606", name: "U4M/GM1028", category: "Equipment", isPopular: false },
            { id: "80607", name: "10G OPTI", category: "Equipment", isPopular: false },
            { id: "80608", name: "1G OPTI", category: "Equipment", isPopular: false },
            { id: "80910", name: "U10X", category: "Equipment", isPopular: false },
            { id: "80609", name: "4200 OUTDOOR ONT", category: "Equipment", isPopular: false },
            { id: "NA", name: "XGSPON Calix SFP+", category: "Hardware", isPopular: false },
            { id: "NA", name: "U6XTG", category: "Equipment", isPopular: true },
            { id: "NA", name: "GP1101", category: "Equipment", isPopular: true },
            { id: "NA", name: "U6T", category: "Equipment", isPopular: true }
        ];

        catalog.forEach((item, index) => { item.uid = index; });

        // --- STATE ---
        let cart = {};  
        let currentFilter = 'All';
        let isDetailsOpen = false;
        // isCartOpen state is now managed by the presence of the 'open' class on the drawer element

        // Initialize Dates
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('orderDate').value = today;
        document.getElementById('orderDateMobile').value = today;

        renderGrid();
        renderCart(); // Initial render to show '0' items

        function syncDates(val) {
            document.getElementById('orderDate').value = val;
            document.getElementById('orderDateMobile').value = val;
        }

        // --- TOGGLE MOBILE DETAILS ---
        function toggleDetails() {
            const el = document.getElementById('orderInputs');
            const chev = document.getElementById('chevron');
            isDetailsOpen = !isDetailsOpen;
            
            if(isDetailsOpen) {
                el.style.maxHeight = "600px";
                el.style.opacity = "1";
                chev.style.transform = "rotate(180deg)";
            } else {
                el.style.maxHeight = "0";
                el.style.opacity = "0";
                chev.style.transform = "rotate(0deg)";
            }
        }

        // --- CART DRAWER LOGIC (CORRECTED) ---
        function toggleCartDrawer() {
            const body = document.body;
            const drawer = document.getElementById('cartDrawer');
            
            // Calculate item count (unique items)
            const cartItemsCount = Object.keys(cart).filter(key => cart[key] > 0).length;
            
            // Determine if we should open/close
            const isOpen = drawer.classList.contains('open');

            if (!isOpen) {
                // If trying to open an empty cart, alert and return
                if (cartItemsCount === 0) {
                    alert("Your cart is empty. Please add items before viewing the cart.");
                    return;
                }
                drawer.classList.add('open');
                body.classList.add('drawer-open');
                renderCart(); // Ensure content is fresh when opening
            } else {
                drawer.classList.remove('open');
                body.classList.remove('drawer-open');
            }
        }

        function renderCart() {
            const cartList = document.getElementById('cartList');
            cartList.innerHTML = '';
            let totalItems = 0;
            
            // Create a sorted list of items currently in the cart
            const cartCatalog = catalog
                .filter(item => cart[item.name] > 0)
                .sort((a, b) => a.name.localeCompare(b.name));
            
            if (cartCatalog.length === 0) {
                cartList.innerHTML = '<p class="text-center text-gray-500 py-12">Your cart is empty. Add items from the catalog above.</p>';
            } else {
                cartCatalog.forEach(item => {
                    const qty = cart[item.name];
                    totalItems++; // Count of unique items
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'flex justify-between items-center p-3 bg-gray-50 rounded-lg shadow-sm border border-gray-100';
                    
                    // The unique ID is stored on the item object (uid)
                    const uid = item.uid;

                    itemDiv.innerHTML = `
                        <div class="flex flex-col flex-grow min-w-0 mr-4">
                            <span class="text-xs font-mono bg-white text-gray-500 px-1.5 py-0.5 rounded self-start">${item.id}</span>
                            <h4 class="font-semibold text-sm text-gray-800 truncate">${item.name}</h4>
                        </div>
                        <div class="flex items-center flex-shrink-0">
                            <button onclick="updateQty(${uid}, -1)" class="w-7 h-7 flex items-center justify-center rounded bg-white shadow-sm text-gray-600 active:bg-gray-200 font-bold text-base touch-manipulation border border-gray-200">-</button>
                            <span class="w-8 text-center font-bold text-gray-800 text-base mx-1">${qty}</span>
                            <button onclick="updateQty(${uid}, 1)" class="w-7 h-7 flex items-center justify-center rounded bg-blue-600 shadow-sm text-white active:bg-blue-800 font-bold text-base touch-manipulation">+</button>
                        </div>
                    `;
                    cartList.appendChild(itemDiv);
                });
            }

            // Update all visible counts
            document.getElementById('totalCount').innerText = totalItems;
            document.getElementById('cartTotalItems').innerText = totalItems;
            document.getElementById('cartDownloadCount').innerText = totalItems;

            // If the cart becomes empty while the drawer is open, close it
            const drawer = document.getElementById('cartDrawer');
            if (totalItems === 0 && drawer.classList.contains('open')) {
                toggleCartDrawer();
            }
        }

        // --- UI ---
        function renderGrid() {
            const container = document.getElementById('gridContainer');
            container.innerHTML = '';
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let displayList = [...catalog].sort((a, b) => (a.isPopular === b.isPopular) ? 0 : a.isPopular ? -1 : 1);

            displayList.forEach(item => {
                if (currentFilter !== 'All' && item.category !== currentFilter) return;
                if (searchTerm && !item.name.toLowerCase().includes(searchTerm) && !item.id.toLowerCase().includes(searchTerm)) return;

                const qty = cart[item.name] || 0;
                const isSelected = qty > 0;
                let icon = getIconForCategory(item.category);

                const card = document.createElement('div');
                card.className = `bg-white p-3 rounded-xl shadow-sm border transition ${isSelected ? 'card-selected' : 'border-gray-200'}`;
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <span class="text-[10px] font-mono bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">${item.id}</span>
                        ${item.isPopular ? '<span class="text-[9px] text-amber-600 font-bold uppercase tracking-wide flex items-center gap-1">‚òÖ Pop</span>' : ''}
                    </div>
                    <div class="flex items-center gap-2 mb-2 h-10">
                        ${icon}
                        <h3 class="font-semibold text-gray-800 text-xs leading-tight line-clamp-2">${item.name}</h3>
                    </div>
                    
                    <div class="flex items-center justify-between mt-auto bg-gray-50 rounded-lg p-1 border border-gray-100">
                        <button onclick="updateQty(${item.uid}, -1)" class="w-8 h-8 flex items-center justify-center rounded bg-white shadow-sm text-gray-600 active:bg-gray-200 font-bold text-lg touch-manipulation">-</button>
                        <input type="number" value="${qty}" class="w-10 text-center bg-transparent font-bold text-gray-800 focus:outline-none text-lg" readonly>
                        <button onclick="updateQty(${item.uid}, 1)" class="w-8 h-8 flex items-center justify-center rounded bg-blue-600 shadow-sm text-white active:bg-blue-800 font-bold text-lg touch-manipulation">+</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function updateQty(uid, change) {
            const item = catalog[uid];  
            if (!item) return;
            if (!cart[item.name]) cart[item.name] = 0;
            
            // Update quantity
            cart[item.name] += change;
            
            // Enforce minimum zero
            if (cart[item.name] < 0) cart[item.name] = 0;
            
            // If quantity is zero, remove the key from the cart object
            if (cart[item.name] === 0) {
                delete cart[item.name];
            }
            
            // Re-render both the main grid and the cart drawer/summary
            renderGrid();
            renderCart();  
        }

        function getIconForCategory(cat) {
            if (cat === 'Equipment') return '<div class="w-5 h-5 text-purple-500 flex-shrink-0"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"></path></svg></div>';
            if (cat === 'Fiber/Copper') return '<div class="w-5 h-5 text-green-500 flex-shrink-0"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg></div>';
            if (cat === 'Plates/Jacks') return '<div class="w-5 h-5 text-orange-500 flex-shrink-0"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg></div>';
            return '<div class="w-5 h-5 text-gray-400 flex-shrink-0"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg></div>';
        }

        function filterCategory(cat) {
            currentFilter = cat;
            document.querySelectorAll('.cat-btn').forEach(btn => {
                const btnText = btn.innerText;
                const matchesCategory = (cat === 'Plates/Jacks' && btnText.includes('Wall')) || (cat !== 'Plates/Jacks' && btnText.includes(cat));
                const matchesAll = cat === 'All' && btnText.includes('All');

                if(matchesCategory || matchesAll) {
                    btn.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.remove('bg-white', 'border-gray-200', 'text-gray-600', 'hover:bg-gray-50');
                } else {
                    btn.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    btn.classList.add('bg-white', 'border-gray-200', 'text-gray-600', 'hover:bg-gray-50');
                }
            });
            renderGrid();
        }

        document.getElementById('searchInput').addEventListener('keyup', renderGrid);

        function generateExcel() {
            const drawer = document.getElementById('cartDrawer');
            if(drawer.classList.contains('open')) toggleCartDrawer(); // Close drawer on download

            const cartItems = catalog.filter(item => cart[item.name] > 0);
            
            if (cartItems.length === 0) {
                 alert("Your cart is empty. Please add items before downloading the request form.");
                 // Open the drawer/focus on the list if it's empty
                 toggleCartDrawer(); 
                 return;
            }
            
            // Check if details are empty
            const issuedBy = document.getElementById('issuedBy').value;
            if(!issuedBy && !confirm("The 'Issued By' field is empty. Do you want to download anyway?")) {
                if(!isDetailsOpen) toggleDetails();
                document.getElementById('issuedBy').focus();
                return;
            }

            const fromWh = document.getElementById('fromWarehouse').value;
            const toWh = document.getElementById('toWarehouse').value;
            const receivedBy = document.getElementById('receivedBy').value;
            
            // GET DATE FROM INPUT
            const rawDate = document.getElementById('orderDate').value;
            const dateStr = new Date(rawDate + "T00:00:00").toLocaleDateString();  

            const midpoint = Math.ceil(cartItems.length / 2);
            const leftColItems = cartItems.slice(0, midpoint);
            const rightColItems = cartItems.slice(midpoint);

            let ws_data = [
                ["BROADBAND MATERIAL ISSUE SHEET"], 
                [], 
                ["FROM WAREHOUSE:", fromWh, "", "ISSUED BY:", issuedBy, "DATE:", dateStr],
                ["TO WAREHOUSE:", toWh, "", "RECEIVED BY:", receivedBy, "", ""],
                [], 
                ["ITEM #", "DESCRIPTION", "QTY", "", "ITEM #", "DESCRIPTION", "QTY"], 
            ];

            const maxRows = Math.max(leftColItems.length, rightColItems.length);

            for (let i = 0; i < maxRows; i++) {
                const leftItem = leftColItems[i] || { id: "", name: "" };
                const rightItem = rightColItems[i] || { id: "", name: "" };

                const leftQty = leftItem.name ? (cart[leftItem.name] || "") : "";
                const rightQty = rightItem.name ? (cart[rightItem.name] || "") : "";

                ws_data.push([
                    leftItem.id, leftItem.name, leftQty, "", 
                    rightItem.id, rightItem.name, rightQty
                ]);
            }

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch: 10}, {wch: 35}, {wch: 8}, {wch: 5}, {wch: 10}, {wch: 35}, {wch: 8} ];

            // Apply merge for the title row
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }];
            
            // Center the title
            const titleCell = ws['A1'];
            if (titleCell) {
                titleCell.s = { alignment: { horizontal: "center" } };
            }

            XLSX.utils.book_append_sheet(wb, ws, "Request");
            XLSX.writeFile(wb, `Broadband_Request_${issuedBy || 'Order'}_${rawDate}.xlsx`);
        }
    </script>
</body>
</html>
